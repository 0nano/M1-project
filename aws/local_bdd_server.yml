- name: install docker and docker-compose
  become: yes
  apt:
    update_cache: yes
    name: "{{ item }}"
    state: present
  with_items:
    - apt-transport-https
    - ca-certificates
    - curl
    - lsb-release
    - gnupg2
    - python3-pip
    
- name: Add Docker GPG key
  shell: 'curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg'

- name: Add the repository to fetch the docker package
  shell: 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian bullseye stable" | tee /etc/apt/sources.list.d/docker.list'

- name: Update source list and then install docker
  apt:
    update_cache: yes
    name: docker-ce
    state: latest 

- name: Install the Docker module for Python, required by ansible
  apt:
    name: python3-docker
    state: present

- name: Install docker-compose
  apt:
    name: docker-compose
    state: present

- name: Install dependencies for postgresql
  apt:
    name: python3-psycopg2
    state: present

- name: Install postgresql on container
  docker_container:
    name: postgresql
    image: postgres:latest
    state: started
    ports:
      - "5433:5433"
    env:
      POSTGRES_USER: "admin"
      POSTGRES_PASSWORD: "admin"
      POSTGRES_DB: "bdd"

- name: Wait for PostgreSQL to initialize
  wait_for:
    host: localhost
    port: 5433
    state: started
    delay: 10
    timeout: 60